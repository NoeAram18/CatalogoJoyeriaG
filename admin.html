<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gedalia ERP | Gesti√≥n Masiva</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #c5a059; --black: #0a0a0a; --bg: #f4f7f6; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; background: var(--bg); color: #333; }
        .sidebar { width: 280px; background: var(--black); height: 100vh; color: white; padding: 40px 20px; position: fixed; }
        .main { margin-left: 280px; padding: 40px; width: calc(100% - 280px); }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 4px solid var(--gold); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: white; }
        .btn-black { background: var(--black); color: white; }
        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .section { display: none; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .excel-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 12px; background: #fafafa; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="color:var(--gold); letter-spacing:3px;">GEDALIA</h2>
    <div style="margin-top:50px;">
        <p onclick="showSection('stats')" style="cursor:pointer; padding:10px 0;">üìä Panel de Control</p>
        <p onclick="showSection('inventory')" style="cursor:pointer; padding:10px 0;">üíé Inventario (450+)</p>
        <p onclick="prepareNew()" style="cursor:pointer; padding:10px 0;">‚ú® Nueva Pieza</p>
        <p onclick="showSection('bulk')" style="cursor:pointer; padding:10px 0;">üìÇ Carga Masiva Excel</p>
    </div>
</div>

<div class="main">
    <div id="stats" class="section active">
        <div class="stat-grid">
            <div class="stat-card"><h4>Vistas</h4><p id="total-vistas" style="font-size:24px; font-weight:700;">0</p></div>
            <div class="stat-card"><h4>Clicks</h4><p id="total-clicks" style="font-size:24px; font-weight:700;">0</p></div>
            <div class="stat-card"><h4>Conversi√≥n</h4><p id="conv-rate" style="font-size:24px; font-weight:700;">0%</p></div>
        </div>
        <div class="card">
            <h3>Top Rendimiento</h3>
            <table id="tabla-stats"></table>
        </div>
    </div>

    <div id="inventory" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Inventario General</h3>
                <input type="text" id="admin-search" placeholder="Filtrar por nombre..." oninput="filtrarAdmin()" style="width:250px;">
            </div>
            <table id="lista-prods"></table>
        </div>
    </div>

    <div id="form-section" class="section">
        <div class="card">
            <h3 id="form-title">Nueva Joya</h3>
            <input type="hidden" id="edit-id">
            <div class="input-group"><input type="text" id="n" placeholder="Nombre de la pieza"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <select id="c"><option value="Anillos">Anillos</option><option value="Dije">Dije</option><option value="Collares">Collares</option><option value="Aretes">Aretes</option><option value="Pulseras">Pulseras</option></select>
                <input type="number" id="p" placeholder="Precio USD">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <input type="number" id="desc" placeholder="% Descuento">
                <select id="envio"><option value="false">Env√≠o Pagado</option><option value="true">Env√≠o Gratis</option></select>
            </div>
            <div style="margin-top:20px;">
                <p style="font-size:12px; color:#888;">Im√°genes (Mantenemos el l√≠mite de 3 para lujo)</p>
                <input type="file" id="f1" accept="image/*" style="margin-bottom:5px;">
                <input type="file" id="f2" accept="image/*" style="margin-bottom:5px;">
                <input type="file" id="f3" accept="image/*">
            </div>
            <button id="btn-save" class="btn btn-gold" style="width:100%; margin-top:20px;" onclick="guardar()">GUARDAR PRODUCTO</button>
        </div>
    </div>

    <div id="bulk" class="section">
        <div class="card">
            <h3>Carga Masiva (Archivo .CSV)</h3>
            <p style="font-size:13px; color:#666;">Use el formato: nombre, categoria, precioBase, descuento, envioGratis (true/false)</p>
            <div class="excel-box">
                <input type="file" id="csv-file" accept=".csv">
                <button class="btn btn-black" style="margin-top:15px;" onclick="procesarCSV()">CARGAR EXCEL A GEDALIA</button>
            </div>
        </div>
    </div>
</div>

<script>
    let productos = [];
    async function cargar() {
        const res = await fetch('/api/admin/productos-todos');
        productos = await res.json();
        renderInventory(productos);
        renderStats();
    }

    function renderStats() {
        const tv = productos.reduce((a, b) => a + b.vistas, 0);
        const tc = productos.reduce((a, b) => a + b.interacciones, 0);
        document.getElementById('total-vistas').innerText = tv;
        document.getElementById('total-clicks').innerText = tc;
        document.getElementById('conv-rate').innerText = tv > 0 ? ((tc/tv)*100).toFixed(1) + "%" : "0%";
    }

    function renderInventory(lista) {
        document.getElementById('lista-prods').innerHTML = `
            <thead><tr><th>Pieza</th><th>Precio</th><th>Stats</th><th>Acciones</th></tr></thead>
            <tbody>${lista.map(p => `
                <tr>
                    <td><b>${p.nombre}</b></td>
                    <td>$${p.precioBase}</td>
                    <td>${p.vistas}üëÄ / ${p.interacciones}‚ö°</td>
                    <td>
                        <button class="btn-gold" onclick="editar('${p._id}')">‚úèÔ∏è</button>
                        <button onclick="eliminar('${p._id}')" style="background:#ffebee; color:red; border:none; padding:8px; border-radius:5px;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('')}</tbody>
        `;
    }

    function filtrarAdmin() {
        const q = document.getElementById('admin-search').value.toLowerCase();
        renderInventory(productos.filter(p => p.nombre.toLowerCase().includes(q)));
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function prepareNew() { 
        document.getElementById('edit-id').value = ""; 
        document.querySelectorAll('input').forEach(i => i.value = "");
        showSection('form-section'); 
    }

    async function procesarImg(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 1200;
                    let w = img.width, h = img.height;
                    if(w > MAX) { h *= MAX/w; w = MAX; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(async b => {
                        const fd = new FormData(); fd.append('image', b);
                        const r = await fetch('/api/admin/upload-image', { method: 'POST', body: fd });
                        const d = await r.json(); resolve(d.url);
                    }, 'image/jpeg', 0.8);
                }
            }
        });
    }

    async function guardar() {
        const btn = document.getElementById('btn-save');
        btn.disabled = true; btn.innerText = "PROCESANDO...";
        const id = document.getElementById('edit-id').value;
        const urls = [];
        const files = [document.getElementById('f1').files[0], document.getElementById('f2').files[0], document.getElementById('f3').files[0]];
        for(let f of files) { if(f) urls.push(await procesarImg(f)); }

        const payload = {
            nombre: document.getElementById('n').value,
            categoria: document.getElementById('c').value,
            precioBase: Number(document.getElementById('p').value),
            descuento: Number(document.getElementById('desc').value) || 0,
            envioGratis: document.getElementById('envio').value === "true"
        };
        if(urls.length > 0) payload.imagenes = urls;

        await fetch(id ? `/api/admin/productos/${id}` : '/api/admin/productos', {
            method: id ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        alert("¬°Guardado!"); cargar(); showSection('inventory');
        btn.disabled = false; btn.innerText = "GUARDAR PRODUCTO";
    }

    async function procesarCSV() {
        const file = document.getElementById('csv-file').files[0];
        if(!file) return alert("Seleccione un archivo");
        const reader = new FileReader();
        reader.onload = async (e) => {
            const lines = e.target.result.split('\n').slice(1);
            const data = lines.filter(l => l.trim()).map(line => {
                const [nombre, categoria, precioBase, descuento, envioGratis] = line.split(',');
                return { nombre, categoria, precioBase: Number(precioBase), descuento: Number(descuento), envioGratis: envioGratis.trim() === 'true' };
            });
            await fetch('/api/admin/productos-bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            alert("Carga masiva completada"); cargar();
        };
        reader.readAsText(file);
    }

    async function eliminar(id) { if(confirm("¬øEliminar?")) { await fetch(`/api/admin/productos/${id}`, { method: 'DELETE' }); cargar(); } }

    cargar();
</script>
</body>
</html>
