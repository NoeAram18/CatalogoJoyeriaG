<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atelier Luxury</title>
    <style>
        :root { --oro: #c5a059; }
        body { font-family: serif; margin: 0; padding: 20px; color: #1a1a1a; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 25px; max-width: 1200px; margin: auto; }
        .card { border: 1px solid #f0f0f0; padding: 15px; cursor: pointer; text-align: center; transition: 0.3s; }
        .card.selected { border-color: var(--oro); background: #fffcf5; box-shadow: 0 5px 15px rgba(197,160,89,0.1); }
        .card img { width: 100%; height: 250px; object-fit: cover; }
        .thumbs { display: flex; gap: 5px; justify-content: center; margin-top: 10px; }
        .thumb { width: 45px; height: 45px; object-fit: cover; border: 1px solid #eee; }
        .thumb:hover { border-color: var(--oro); }
        .form-area { max-width: 500px; margin: 40px auto; background: #fafafa; padding: 30px; border-radius: 8px; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; }
        button { background: #000; color: #fff; border: none; cursor: pointer; font-weight: bold; letter-spacing: 2px; }
        button:hover { background: var(--oro); }
    </style>
</head>
<body>
    <h1 style="text-align:center; font-weight:300; letter-spacing:5px;">ATELIER LUXURY</h1>
    
    <div class="grid" id="catalogo"></div>

    <div class="form-area">
        <h3 id="joya-info" style="text-align:center; font-weight:300;">Selecciona una joya</h3>
        <input type="text" id="cliente" placeholder="Tu Nombre Completo">
        <input type="file" id="foto" accept="image/*">
        <button id="btn" onclick="enviar()">SOLICITAR MONTAJE PERSONALIZADO</button>
        <p id="msg" style="text-align:center; font-size:14px; color:var(--oro);"></p>
    </div>

    <script>
        let prods = [];
        let sel = null;

        async function cargar() {
            try {
                const res = await fetch('/api/productos');
                prods = await res.json();
                render();
            } catch (e) { console.error("Error al cargar piezas"); }
        }

        function render() {
            const div = document.getElementById('catalogo');
            div.innerHTML = prods.map(p => {
                const imgPrincipal = p.imagenes[0];
                const thumbsHtml = p.imagenes.map(img => `
                    <img src="${img}" class="thumb" onmouseover="document.getElementById('main-${p._id}').src='${img}'">
                `).join('');

                return `
                    <div class="card ${sel?.id === p._id ? 'selected' : ''}" onclick="seleccionar('${p._id}')">
                        <img src="${imgPrincipal}" id="main-${p._id}">
                        <div class="thumbs">${thumbsHtml}</div>
                        <p style="margin-top:15px;"><strong>${p.nombre}</strong><br><span style="color:var(--oro)">$${p.precioBase} USD</span></p>
                    </div>
                `;
            }).join('');
        }

        function seleccionar(id) {
            const p = prods.find(x => x._id === id);
            sel = { 
                id: p._id, 
                nombre: p.nombre, 
                url: document.getElementById(`main-${p._id}`).src 
            };
            document.getElementById('joya-info').innerText = "Has elegido: " + p.nombre;
            render();
        }

        async function enviar() {
            const f = document.getElementById('foto').files[0];
            const n = document.getElementById('cliente').value;
            if(!sel || !f || !n) return alert("Por favor selecciona una joya, escribe tu nombre y sube tu foto.");

            const fd = new FormData();
            fd.append('userImage', f);
            fd.append('catalogPath', sel.url);
            fd.append('clientName', n);
            fd.append('joyaNombre', sel.nombre);

            document.getElementById('msg').innerText = "Enviando solicitud a nuestros diseñadores...";
            document.getElementById('btn').disabled = true;

            const res = await fetch('/send-to-telegram', { method: 'POST', body: fd });
            if(res.ok) {
                document.getElementById('msg').innerHTML = "✅ ¡Solicitud enviada!<br>Mantente atento, procesaremos tu montaje pronto.";
            }
        }

        cargar();
    </script>
</body>
</html>
