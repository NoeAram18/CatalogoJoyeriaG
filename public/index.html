<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joyería Luxury - Personalizador</title>
    <style>
        :root { --oro: #c5a059; --dark: #1a1a1a; }
        body { font-family: 'serif'; background: #fff; margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 900px; margin: auto; }
        .filter-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .filter-btn { padding: 10px 20px; border: 1px solid var(--oro); background: transparent; cursor: pointer; border-radius: 20px; }
        .filter-btn.active { background: var(--oro); color: white; }
        .grid-joyas { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .joya-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; text-align: center; }
        .joya-card.selected { border: 2px solid var(--oro); background: #fdfaf4; }
        .joya-card img { width: 100%; height: 200px; object-fit: cover; }
        .config-section { background: #f9f9f9; padding: 20px; border-radius: 10px; margin-top: 20px; }
        select, input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: var(--dark); color: white; border: none; font-weight: bold; cursor: pointer; }
        .price-display { font-size: 22px; color: var(--oro); font-weight: bold; text-align: center; }
        #status-area { display: none; margin-top: 20px; border: 2px solid var(--oro); padding: 15px; text-align: center; }
        #final-design { width: 100%; max-width: 400px; display: none; margin: 15px auto; border-radius: 10px; }
        .btn-whatsapp { background: #25d366 !important; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center">Atelier Joyería</h1>
    
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterCat('Todos', this)">Todos</button>
        <button class="filter-btn" onclick="filterCat('Anillos', this)">Anillos</button>
        <button class="filter-btn" onclick="filterCat('Collares', this)">Collares</button>
    </div>

    <div class="grid-joyas" id="catalogo"></div>

    <div class="config-section">
        <h3>Configuración y Precio</h3>
        <select id="metalSelect" onchange="updatePrice()">
            <option value="1" data-name="Plata Ley 950">Plata Ley 950 (Precio Base)</option>
            <option value="5" data-name="Oro 14k">Oro 14k (Base x 5)</option>
            <option value="8" data-name="Oro 18k">Oro 18k (Base x 8)</option>
        </select>
        <div class="price-display" id="totalPrice">Seleccione una joya</div>
        <input type="text" id="nombre" placeholder="Nombre">
        <input type="file" id="foto" accept="image/*">
        <button id="btnEnviar" onclick="enviarPedido()">ENVIAR PARA EDICIÓN</button>
    </div>

    <div id="status-area">
        <p id="status-msg">⏳ Procesando...</p>
        <img id="final-design">
        <button id="btnWA" class="btn-whatsapp" onclick="irAWhatsApp()">✨ ¡LO QUIERO! COMPRAR POR WHATSAPP</button>
    </div>
</div>

<script>
    // --- ACTUALIZA TUS LINKS AQUÍ ---
    // IMPORTANTE: Intenta que terminen en .jpg o .png
    const misProductos = [
        { id: "A1", nombre: "Anillo Gala", cat: "Anillos", precio: 100, url: "https://i.ibb.co/GQw8Jy2r/yellow-7.avif" },
        { id: "C1", nombre: "Collar Reina", cat: "Collares", precio: 250, url: "https://i.ibb.co/example/collar.jpg" }
    ];

    let currentJoya = null;
    let clientIdActual = null;

    function renderCatalog(category = 'Todos') {
        const catDiv = document.getElementById('catalogo');
        catDiv.innerHTML = '';
        const filtered = category === 'Todos' ? misProductos : misProductos.filter(p => p.cat === category);
        filtered.forEach(p => {
            const card = document.createElement('div');
            card.className = `joya-card ${currentJoya?.id === p.id ? 'selected' : ''}`;
            card.onclick = () => { currentJoya = p; renderCatalog(category); updatePrice(); };
            card.innerHTML = `<img src="${p.url}"><div style="padding:10px"><strong>${p.nombre}</strong><br>$${p.precio}</div>`;
            catDiv.appendChild(card);
        });
    }

    function filterCat(cat, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderCatalog(cat);
    }

    function updatePrice() {
        if (!currentJoya) return;
        const total = currentJoya.precio * document.getElementById('metalSelect').value;
        document.getElementById('totalPrice').innerText = `Total: $${total} USD`;
    }

    async function enviarPedido() {
        const foto = document.getElementById('foto').files[0];
        const nombre = document.getElementById('nombre').value;
        if (!currentJoya || !foto || !nombre) return alert("Completa los datos");

        document.getElementById('status-area').style.display = 'block';
        document.getElementById('btnEnviar').disabled = true;

        const formData = new FormData();
        formData.append('userImage', foto);
        formData.append('catalogPath', currentJoya.url);
        formData.append('clientName', nombre);

        const res = await fetch('/send-to-telegram', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            clientIdActual = data.clientId;
            iniciarEspera(data.clientId);
        }
    }

    function iniciarEspera(id) {
        const int = setInterval(async () => {
            const res = await fetch(`/check-edition/${id}`);
            const data = await res.json();
            if (data.ready) {
                clearInterval(int);
                document.getElementById('status-msg').innerHTML = "✨ **¡Diseño listo!**";
                const img = document.getElementById('final-design');
                img.src = data.url;
                img.style.display = 'block';
                document.getElementById('btnWA').style.display = 'block';
            }
        }, 5000);
    }

    function irAWhatsApp() {
        const metal = document.getElementById('metalSelect').selectedOptions[0].getAttribute('data-name');
        const mensaje = encodeURIComponent(`¡Hola! Me gusta este diseño.\nJoya: ${currentJoya.nombre}\nMetal: ${metal}\nID: ${clientIdActual}`);
        window.open(`https://wa.me/TUNUMERO?text=${mensaje}`, '_blank');
    }

    renderCatalog();
</script>
</body>
</html>
